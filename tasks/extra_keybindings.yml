---
- name: Configure xremap keybindings

  block:
    - name: Create local directories
      become: false
      file:
        path: "/home/{{ ansible_user }}/{{ item }}"
        recurse: yes
        state: directory
      with_items:
        - ".local/share/xremap-features/kde"
        - ".local/share/xremap-features/gnome"
        - ".local/share/xremap-features/cosmic"

    - name: Install xremap Rust packages
      become: false
      community.general.cargo:
        name: xremap
        path: "/home/{{ ansible_user }}/.local/share/xremap-features/{{ item }}"
        features:
          - "{{ item }}"
      loop:
        - gnome
        - kde
        - cosmic


    - name: Add the target user to the 'input' group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: input
        append: yes

    - name: Ensure uinput kernel module is configured to load on boot
      ansible.builtin.copy:
        dest: /etc/modules-load.d/uinput.conf
        content: |
          uinput
        owner: root
        group: root
        mode: '0644'

    - name: Create udev rule to grant access to uinput for logged-in users
      ansible.builtin.copy:
        dest: /etc/udev/rules.d/99-input-for-xremap.rules
        content: |
          KERNEL=="uinput", GROUP="input", TAG+="uaccess"
        owner: root
        group: root
        mode: '0644'

    - name: Create the smart launcher script
      become: false
      ansible.builtin.copy:
        dest: "/home/{{ ansible_user }}/.local/bin/xremap-launcher"
        mode: '0755'
        content: |
          #!/bin/bash
          # Managed by Ansible

          CONFIG_PATH="$1"
          if [ -z "$CONFIG_PATH" ]; then
              CONFIG_PATH="$HOME/.config/xremap/config.yml"
          fi

          DESKTOP_ENV="${XDG_CURRENT_DESKTOP,,}"
          echo "Launcher detected Desktop Environment: $XDG_CURRENT_DESKTOP"

          if [[ "$DESKTOP_ENV" == *"gnome"* ]]; then
              BIN_DIR="gnome"
          elif [[ "$DESKTOP_ENV" == *"kde"* ]] || [[ "$DESKTOP_ENV" == *"plasma"* ]]; then
              BIN_DIR="kde"
          elif [[ "$DESKTOP_ENV" == *"cosmic"* ]]; then
              BIN_DIR="cosmic"
          else
              echo "Warning: Unknown environment $XDG_CURRENT_DESKTOP, defaulting to generic xremap if available or failing."
              # Here you can choose to fallback to a specific version or exit with an error
              exit 1
          fi

          EXECUTABLE="$HOME/.local/share/xremap-features/$BIN_DIR/bin/xremap"

          # Check if the binary file exists
          if [ ! -f "$EXECUTABLE" ]; then
              echo "Error: Binary $EXECUTABLE not found."
              exit 1
          fi

          echo "Starting xremap with config $CONFIG_PATH"
          exec "$EXECUTABLE" "$CONFIG_PATH" --watch

    - name: Create the xremap systemd user service
      become: false
      ansible.builtin.copy:
        dest: "/home/{{ ansible_user }}/.config/systemd/user/xremap.service"
        mode: '0644'
        content: |
          [Unit]
          Description=Xremap input remapper (Multi-DE support)
          Documentation=https://github.com/xremap/xremap

          # Wait for graphical session to be ready
          After=graphical-session.target
          Wants=graphical-session.target

          [Service]
          Type=simple
          KillMode=process
          # Pass environment variables to script to identify desktop environment
          PassEnvironment=DISPLAY XAUTHORITY XDG_CURRENT_DESKTOP

          # Point to our smart script and pass the config file path as an argument
          ExecStart=/home/{{ ansible_user }}/.local/bin/xremap-launcher /home/{{ ansible_user }}/.config/xremap/config.yml

          Restart=always
          RestartSec=5

          [Install]
          WantedBy=graphical-session.target

    - name: Enable and start xremap service
      become: false
      ansible.builtin.systemd:
        name: xremap
        scope: user
        enabled: true
        state: started
        daemon_reload: true

    # - name: Create the xremap systemd user service file
    #   become: false
    #   ansible.builtin.copy:
    #     dest: "/home/{{ ansible_user }}/.config/systemd/user/xremap.service"
    #     mode: '0644'
    #     content: |
    #       [Unit]
    #       Description=Xremap input remapper
    #       Documentation=https://github.com/xremap/xremap

    #       [Service]
    #       # KillMode=process is important to ensure xremap and its child processes are terminated correctly.
    #       KillMode=process
    #       # Use the full path to the executable found by Ansible
    #       ExecStart=/usr/bin/xremap /home/{{ ansible_user }}/.config/xremap/config.yml
    #       Restart=always
    #       RestartSec=3

    #       [Install]
    #       WantedBy=default.target

    # - name: Enable and start the xremap service
    #   become: false
    #   ansible.builtin.systemd_service:
    #     name: "xremap"
    #     scope: user
    #     enabled: true
    #     state: started
